import{_ as i,c as e,a,o as t}from"./app-Tf8BuBYq.js";const n={};function l(h,s){return t(),e("div",null,[...s[0]||(s[0]=[a('<p>本人是使用django开发的网页上线后，手写脚本导入旧版网站数据导致了此问题；后来在由于一些意外迁移生产服务器时再次碰到，决定写一篇博客来记录一下。</p><h4 id="问题描述" tabindex="-1"><a class="header-anchor" href="#问题描述"><span>问题描述</span></a></h4><p>对django的api接口进行请求返回500，无法插入数据，手动执行SQL报错如下：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span>ERROR:  duplicate key value violates unique constraint &quot;xxx&quot;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="问题原因" tabindex="-1"><a class="header-anchor" href="#问题原因"><span>问题原因</span></a></h4><p>如题，已经说明了，是主键冲突异常，具体的导致原因则是postgresql不会像mysql一样（或许mysql也会？我不知道）每次插入数据时重新确认自增主键的取值，而是会使用缓存提高效率。</p><p>这就导致某些情况下插入数据（例如SQL语句中指定了ID）不会更新这个自增主键下一个取值的缓存，进而在下次插入时触发错误。</p><h4 id="解决方案" tabindex="-1"><a class="header-anchor" href="#解决方案"><span>解决方案</span></a></h4><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-sql"><span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">SELECT</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> setval(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">TABLE_COLUMN_seq</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, (</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">SELECT</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;"> max</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(COLUMN) </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">FROM</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">TABLE</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">));</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>其中 <code>TABLE</code> 是表名，<code>COLUMN</code> 是自增的那一列的名字，例如：</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-sql"><span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">SELECT</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> setval(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">user_id_seq</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, (</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">SELECT</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;"> max</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(id) </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">FROM</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">user</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">));</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="报错及解决" tabindex="-1"><a class="header-anchor" href="#报错及解决"><span>报错及解决</span></a></h4><p>如果你不幸和我一样遇到了这个报错：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span>ERROR:  currval of sequence &quot;user_id_seq&quot; is not yet defined in this session</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>请尝试先执行如下语句：</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-sql"><span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">SELECT</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> nextval(pg_get_serial_sequence(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">user</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">id</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">));</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>具体哪些字段需要替换不用我再说了吧~</p><h4 id="参考资料" tabindex="-1"><a class="header-anchor" href="#参考资料"><span>参考资料</span></a></h4><ul><li><a href="https://blog.csdn.net/ant98002/article/details/102248262" target="_blank" rel="noopener noreferrer">POSTGRESQL 插入数据时主键冲突异常_ant98002的博客-CSDN博客</a></li><li><a href="https://itectec.com/database/postgresql-error-currval-of-sequence-rss_sub_source_id_seq-is-not-yet-defined-in-this-session/" target="_blank" rel="noopener noreferrer">Postgresql – ERROR: currval of sequence “rss_sub_source_id_seq” is not yet defined in this session – iTecTec</a></li></ul>',19)])])}const d=i(n,[["render",l]]),p=JSON.parse('{"path":"/article/p256ofhj/","title":"PostgreSQL插入数据时主键冲突异常（ERROR_duplicate key value violates unique constraint）","lang":"zh-CN","frontmatter":{"title":"PostgreSQL插入数据时主键冲突异常（ERROR_duplicate key value violates unique constraint）","createTime":"2022/08/28 18:29:10","tags":["后端"],"permalink":"/article/p256ofhj/","description":"本人是使用django开发的网页上线后，手写脚本导入旧版网站数据导致了此问题；后来在由于一些意外迁移生产服务器时再次碰到，决定写一篇博客来记录一下。 问题描述 对django的api接口进行请求返回500，无法插入数据，手动执行SQL报错如下： 问题原因 如题，已经说明了，是主键冲突异常，具体的导致原因则是postgresql不会像mysql一样（或许...","head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"PostgreSQL插入数据时主键冲突异常（ERROR_duplicate key value violates unique constraint）\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2025-10-10T04:50:50.000Z\\",\\"author\\":[]}"],["meta",{"property":"og:url","content":"https://yxzl.dev/article/p256ofhj/"}],["meta",{"property":"og:site_name","content":"异想之旅のBlog"}],["meta",{"property":"og:title","content":"PostgreSQL插入数据时主键冲突异常（ERROR_duplicate key value violates unique constraint）"}],["meta",{"property":"og:description","content":"本人是使用django开发的网页上线后，手写脚本导入旧版网站数据导致了此问题；后来在由于一些意外迁移生产服务器时再次碰到，决定写一篇博客来记录一下。 问题描述 对django的api接口进行请求返回500，无法插入数据，手动执行SQL报错如下： 问题原因 如题，已经说明了，是主键冲突异常，具体的导致原因则是postgresql不会像mysql一样（或许..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-10-10T04:50:50.000Z"}],["meta",{"property":"article:tag","content":"后端"}],["meta",{"property":"article:modified_time","content":"2025-10-10T04:50:50.000Z"}]]},"git":{"createdTime":1758874804000,"updatedTime":1760071850000},"autoDesc":true,"filePathRelative":"tech/20220828182910.md","headers":[]}');export{d as comp,p as data};
